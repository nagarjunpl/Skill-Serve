<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Dashboard - SkillServe</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body data-page-title="customer dashboard">
    <div class="container">
        <header class="dashboard-header">
            <div class="logo">
                <h1>üîß SkillServe</h1>
            </div>
            <nav class="nav">
                <a href="customer-dashboard.html" class="nav-link active" data-translate="home">Home</a>
                <a href="#" onclick="showBookings()" class="nav-link" data-translate="my bookings">My Bookings</a>
                <a href="#" onclick="showProfile()" class="nav-link" data-translate="profile">Profile</a>
                <button onclick="refreshWorkerData()" class="btn btn-refresh" title="Refresh worker data from storage.js">üîÑ <span data-translate="refresh">Refresh Data</span></button>
                <a href="#" onclick="logout()" class="nav-link" data-translate="logout">Logout</a>
            </nav>
        </header>

        <main class="dashboard-main">
            <div id="homeSection">
                <div class="welcome-section">
                    <h2 id="welcomeMessage">Welcome, Customer!</h2>
                    <p data-translate="find local skilled workers">Find and book skilled workers in your area</p>
                </div>

                <div class="search-section">
                    <div class="search-controls">
                        <select id="workerTypeFilter">
                            <option value="">All Professions</option>
                            <option value="electrician" data-translate="electrician">Electrician</option>
                            <option value="plumber" data-translate="plumber">Plumber</option>
                            <option value="painter" data-translate="painter">Painter</option>
                            <option value="carpenter" data-translate="carpenter">Carpenter</option>
                            <option value="mechanic" data-translate="mechanic">Mechanic</option>
                            <option value="cleaner" data-translate="cleaner">Cleaner</option>
                        </select>
                        <div class="location-search-container">
                            <input type="text" id="locationSearch" placeholder="Search location..." autocomplete="off" data-translate="location">
                            <div id="locationSuggestions" class="location-suggestions"></div>
                        </div>
                        <button id="searchBtn" class="btn btn-primary" data-translate="search">Search Workers</button>
                        <button id="clearFiltersBtn" class="btn btn-secondary" data-translate="clear">Clear Filters</button>
                    </div>
                </div>

                <div id="workersSection" class="workers-section">
                    <h3>Available Workers</h3>
                    <div id="workersList" class="workers-grid">
                        <!-- Workers will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div id="bookingsSection" class="bookings-section" style="display: none;">
                <h3 data-translate="my bookings">My Bookings</h3>
                <div id="bookingsList" class="bookings-list">
                    <!-- Bookings will be populated by JavaScript -->
                </div>
            </div>

            <div id="profileSection" class="profile-section" style="display: none;">
                <h3 data-translate="profile">My Profile</h3>
                <div class="profile-card">
                    <div id="profileDisplay">
                        <!-- Profile info will be populated by JavaScript -->
                    </div>
                    <div id="profileEdit" style="display: none;">
                        <form id="profileEditForm">
                            <div class="form-group">
                                <label for="editName" data-translate="name">Full Name</label>
                                <input type="text" id="editName" required>
                            </div>
                            <div class="form-group">
                                <label for="editEmail" data-translate="email">Email</label>
                                <input type="email" id="editEmail" required>
                            </div>
                            <div class="form-group">
                                <label for="editPhone" data-translate="phone">Phone Number</label>
                                <input type="tel" id="editPhone">
                            </div>
                            <div class="form-group">
                                <label for="editAddress" data-translate="address">Address</label>
                                <textarea id="editAddress" rows="3"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary" data-translate="save">Save Changes</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelEdit()" data-translate="cancel">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 data-translate="book service">Book Service</h3>
            <form id="bookingForm">
                <div class="form-group">
                    <label for="issueDescription" data-translate="describe your issue">Describe your issue</label>
                    <textarea id="issueDescription" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label for="preferredDate" data-translate="preferred date">Preferred Date</label>
                    <input type="date" id="preferredDate" required>
                </div>
                <div class="form-group">
                    <label for="preferredTime" data-translate="preferred time">Preferred Time</label>
                    <input type="time" id="preferredTime" required>
                </div>
                <div class="form-group">
                    <label for="contactNumber" data-translate="contact number">Contact Number</label>
                    <input type="tel" id="contactNumber" required>
                </div>
                <button type="submit" class="btn btn-primary">Submit Booking</button>
            </form>
        </div>
    </div>

    <!-- rl -->
    <div id="ratingModal" class="modal">
        <div class="modal-content">
            <span class="close-rating">&times;</span>
            <h3 data-translate="rate your experience">Rate Your Experience</h3>
            <div id="ratingWorkerInfo" class="rating-worker-info">
            
            </div>
            <form id="ratingForm">
                <div class="form-group">
                    <label>How would you rate this worker?</label>
                    <div class="star-rating">
                        <span class="star" data-rating="1">‚≠ê</span>
                        <span class="star" data-rating="2">‚≠ê</span>
                        <span class="star" data-rating="3">‚≠ê</span>
                        <span class="star" data-rating="4">‚≠ê</span>
                        <span class="star" data-rating="5">‚≠ê</span>
                    </div>
                    <input type="hidden" id="selectedRating" required>
                </div>
                <div class="form-group">
                    <label for="reviewComment">Review (Optional)</label>
                    <textarea id="reviewComment" rows="3" placeholder="Share your experience with this worker..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" data-translate="submit rating">Submit Rating</button>
            </form>
        </div>
    </div

    <!-- Cancel Booking Confirmation Modal -->
    <div id="cancelBookingModal" class="modal">
        <div class="modal-content cancel-booking-modal">
            <span class="close-cancel">&times;</span>
            <div class="cancel-warning">
                <div class="warning-icon">‚ùå</div>
                <h3>Cancel Booking</h3>
                <p>Are you sure you want to cancel this booking?</p>
                <div id="cancelBookingInfo" class="cancel-booking-info">
                    <!-- Booking info will be populated -->
                </div>
                <div class="cancel-actions">
                    <button id="confirmCancelBtn" class="btn btn-danger">Yes, Cancel Booking</button>
                    <button class="btn btn-secondary" onclick="closeCancelModal()">Keep Booking</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content delete-modal">
            <span class="close-delete">&times;</span>
            <div class="delete-warning">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <h3 data-translate="delete">Delete Account</h3>
                <p>Are you sure you want to permanently delete your account?</p>
                <div class="delete-consequences">
                    <h4>This action will:</h4>
                    <ul>
                        <li>Permanently delete your profile</li>
                        <li>Cancel all pending bookings</li>
                        <li>Remove your booking history</li>
                        <li>This action cannot be undone</li>
                    </ul>
                </div>
                <div class="delete-confirmation">
                    <p>Type <strong>"DELETE"</strong> to confirm:</p>
                    <input type="text" id="deleteConfirmText" placeholder="Type DELETE here">
                </div>
                <div class="delete-actions">
                    <button id="confirmDeleteBtn" class="btn btn-danger" disabled>Delete My Account</button>
                    <button class="btn btn-secondary" onclick="closeDeleteModal()" data-translate="cancel">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="storage.js"></script>
    <script src="auth.js"></script>
    <script src="translator.js"></script>
    <script>
        let selectedWorker = null;
        let selectedBookingForRating = null;
        let selectedBookingForCancel = null;
        let availableLocations = [];

        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication
            const currentUser = getCurrentUser();
            if (!currentUser || currentUser.role !== 'customer') {
                window.location.href = 'index.html';
                return;
            }

            // Update welcome message
            document.getElementById('welcomeMessage').textContent = `${translateText('welcome')}, ${currentUser.name}!`;

            // Load available locations from registered workers
            loadAvailableLocations();

            // Load workers
            loadWorkers();

            // Setup event listeners
            setupEventListeners();
        });

        function loadAvailableLocations() {
            const workers = getWorkers();
            const locations = [...new Set(workers.map(worker => worker.location))].sort();
            availableLocations = locations;
        }

        function setupEventListeners() {
            document.getElementById('searchBtn').addEventListener('click', filterWorkers);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            document.getElementById('workerTypeFilter').addEventListener('change', filterWorkers);
            
            // Location search with autocomplete
            const locationSearch = document.getElementById('locationSearch');
            locationSearch.addEventListener('input', handleLocationSearch);
            locationSearch.addEventListener('focus', showLocationSuggestions);
            locationSearch.addEventListener('blur', hideLocationSuggestions);
            
            // Modal functionality
            const modal = document.getElementById('bookingModal');
            const ratingModal = document.getElementById('ratingModal');
            const cancelModal = document.getElementById('cancelBookingModal');
            const deleteModal = document.getElementById('deleteConfirmModal');
            const closeBtn = document.querySelector('.close');
            const closeRatingBtn = document.querySelector('.close-rating');
            const closeCancelBtn = document.querySelector('.close-cancel');
            const closeDeleteBtn = document.querySelector('.close-delete');
            
            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            closeRatingBtn.addEventListener('click', () => {
                ratingModal.style.display = 'none';
            });
            
            closeCancelBtn.addEventListener('click', closeCancelModal);
            closeDeleteBtn.addEventListener('click', closeDeleteModal);
            
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
                if (e.target === ratingModal) {
                    ratingModal.style.display = 'none';
                }
                if (e.target === cancelModal) {
                    closeCancelModal();
                }
                if (e.target === deleteModal) {
                    closeDeleteModal();
                }
            });

            // Booking form
            document.getElementById('bookingForm').addEventListener('submit', submitBooking);
            
            // Profile edit form
            document.getElementById('profileEditForm').addEventListener('submit', saveProfile);
            
            // Rating form
            document.getElementById('ratingForm').addEventListener('submit', submitRating);
            
            // Cancel booking confirmation
            document.getElementById('confirmCancelBtn').addEventListener('click', confirmCancelBooking);
            
            // Delete confirmation
            document.getElementById('deleteConfirmText').addEventListener('input', handleDeleteConfirmation);
            document.getElementById('confirmDeleteBtn').addEventListener('click', deleteAccount);
            
            // Star rating functionality
            setupStarRating();
        }

        function refreshWorkerData() {
            // Show loading message
            const workersList = document.getElementById('workersList');
            workersList.innerHTML = `<p class="loading-message">üîÑ ${translateText('loading')}...</p>`;
            
            // Reset worker data and reload
            resetWorkerData();
            
            // Small delay to show loading message, then reload
            setTimeout(() => {
                window.location.reload();
            }, 500);
        }

        function handleLocationSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const suggestions = availableLocations.filter(location => 
                location.toLowerCase().includes(searchTerm)
            );
            
            displayLocationSuggestions(suggestions);
            
            // Auto-filter as user types
            if (searchTerm.length > 0) {
                filterWorkers();
            }
        }

        function showLocationSuggestions() {
            if (availableLocations.length > 0) {
                displayLocationSuggestions(availableLocations);
            }
        }

        function hideLocationSuggestions() {
            setTimeout(() => {
                document.getElementById('locationSuggestions').style.display = 'none';
            }, 200);
        }

        function displayLocationSuggestions(suggestions) {
            const suggestionsContainer = document.getElementById('locationSuggestions');
            
            if (suggestions.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            suggestionsContainer.innerHTML = suggestions.map(location => `
                <div class="location-suggestion" onclick="selectLocation('${location}')">${location}</div>
            `).join('');
            
            suggestionsContainer.style.display = 'block';
        }

        function selectLocation(location) {
            document.getElementById('locationSearch').value = location;
            document.getElementById('locationSuggestions').style.display = 'none';
            filterWorkers();
        }

        function setupStarRating() {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                star.addEventListener('click', () => {
                    const rating = index + 1;
                    document.getElementById('selectedRating').value = rating;
                    
                    // Update visual feedback
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.style.color = '#f59e0b';
                            s.style.transform = 'scale(1.2)';
                        } else {
                            s.style.color = '#e2e8f0';
                            s.style.transform = 'scale(1)';
                        }
                    });
                });
                
                star.addEventListener('mouseover', () => {
                    const rating = index + 1;
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.style.color = '#f59e0b';
                        } else {
                            s.style.color = '#e2e8f0';
                        }
                    });
                });
            });
            
            // Reset on mouse leave
            document.querySelector('.star-rating').addEventListener('mouseleave', () => {
                const selectedRating = document.getElementById('selectedRating').value;
                stars.forEach((s, i) => {
                    if (i < selectedRating) {
                        s.style.color = '#f59e0b';
                        s.style.transform = 'scale(1.2)';
                    } else {
                        s.style.color = '#e2e8f0';
                        s.style.transform = 'scale(1)';
                    }
                });
            });
        }

        function loadWorkers() {
            const workers = getWorkers();
            displayWorkers(workers);
        }

        function filterWorkers() {
            const selectedType = document.getElementById('workerTypeFilter').value;
            const searchLocation = document.getElementById('locationSearch').value.toLowerCase();
            const workers = getWorkers();
            
            let filteredWorkers = workers;
            
            if (selectedType) {
                filteredWorkers = filteredWorkers.filter(worker => 
                    worker.profession.toLowerCase() === selectedType
                );
            }
            
            if (searchLocation) {
                filteredWorkers = filteredWorkers.filter(worker => 
                    worker.location.toLowerCase().includes(searchLocation)
                );
            }
            
            displayWorkers(filteredWorkers);
        }

        function clearFilters() {
            document.getElementById('workerTypeFilter').value = '';
            document.getElementById('locationSearch').value = '';
            document.getElementById('locationSuggestions').style.display = 'none';
            loadWorkers();
        }

        function displayWorkers(workers) {
            const workersList = document.getElementById('workersList');
            
            if (workers.length === 0) {
                workersList.innerHTML = '<p class="no-results">No workers found matching your criteria.</p>';
                return;
            }

            workersList.innerHTML = workers.map(worker => `
                <div class="worker-card ${worker.available ? 'available' : 'busy'}">
                    <div class="worker-header">
                        <h4>${worker.name}</h4>
                        <div class="status-indicator ${worker.available ? 'available' : 'busy'}">
                            ${worker.available ? `üü¢ ${translateText('available')}` : `üî¥ ${translateText('busy')}`}
                        </div>
                    </div>
                    <div class="worker-info">
                        <p><strong>${translateText('profession')}:</strong> ${translateText(worker.profession.toLowerCase())}</p>
                        <p><strong>${translateText('experience')}:</strong> ${worker.experience} years</p>
                        <p><strong>${translateText('location')}:</strong> ${worker.location}</p>
                        <p><strong>${translateText('contact')}:</strong> 
                            <a href="tel:${worker.contact}" class="phone-link" title="Click to call">
                                üìû ${worker.contact}
                            </a>
                        </p>
                        <p><strong>${translateText('rating')}:</strong> ‚≠ê ${worker.rating}/5 (${worker.completedJobs} jobs)</p>
                        <p class="worker-description">${worker.description}</p>
                    </div>
                    <div class="worker-actions">
                        <button class="btn ${worker.available ? 'btn-primary' : 'btn-disabled'}" 
                                onclick="bookWorker('${worker.id}')" 
                                ${!worker.available ? 'disabled' : ''}>
                            ${worker.available ? translateText('book now') : 'Not Available'}
                        </button>
                        <a href="tel:${worker.contact}" class="btn btn-call" title="Call ${worker.name}">
                            üìû ${translateText('call now')}
                        </a>
                    </div>
                </div>
            `).join('');
        }

        function bookWorker(workerId) {
            const workers = getWorkers();
            selectedWorker = workers.find(w => w.id === workerId);
            
            if (selectedWorker && selectedWorker.available) {
                document.getElementById('bookingModal').style.display = 'block';
            }
        }

        function submitBooking(e) {
            e.preventDefault();
            
            const currentUser = getCurrentUser();
            const booking = {
                id: Date.now().toString(),
                customerId: currentUser.id,
                customerName: currentUser.name,
                workerId: selectedWorker.id,
                workerName: selectedWorker.name,
                workerProfession: selectedWorker.profession,
                issueDescription: document.getElementById('issueDescription').value,
                preferredDate: document.getElementById('preferredDate').value,
                preferredTime: document.getElementById('preferredTime').value,
                contactNumber: document.getElementById('contactNumber').value,
                status: 'pending',
                createdAt: new Date().toISOString(),
                canRate: false
            };

            // Save booking
            const bookings = getBookings();
            bookings.push(booking);
            saveBookings(bookings);

            // Close modal and reset form
            document.getElementById('bookingModal').style.display = 'none';
            document.getElementById('bookingForm').reset();

            alert('Booking submitted successfully! The worker will respond soon.');
        }

        function showHome() {
            document.getElementById('homeSection').style.display = 'block';
            document.getElementById('bookingsSection').style.display = 'none';
            document.getElementById('profileSection').style.display = 'none';
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector('[href="customer-dashboard.html"]').classList.add('active');
        }

        function showBookings() {
            document.getElementById('homeSection').style.display = 'none';
            document.getElementById('bookingsSection').style.display = 'block';
            document.getElementById('profileSection').style.display = 'none';
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector('[onclick="showBookings()"]').classList.add('active');
            
            loadMyBookings();
        }

        function showProfile() {
            document.getElementById('homeSection').style.display = 'none';
            document.getElementById('bookingsSection').style.display = 'none';
            document.getElementById('profileSection').style.display = 'block';
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector('[onclick="showProfile()"]').classList.add('active');
            
            loadProfile();
        }

        function loadMyBookings() {
            const currentUser = getCurrentUser();
            const bookings = getBookings().filter(booking => booking.customerId === currentUser.id);
            const bookingsList = document.getElementById('bookingsList');

            if (bookings.length === 0) {
                bookingsList.innerHTML = '<p class="no-results">You have no bookings yet.</p>';
                return;
            }

            bookingsList.innerHTML = bookings.map(booking => `
                <div class="booking-card">
                    <div class="booking-header">
                        <h4>${booking.workerName} - ${translateText(booking.workerProfession.toLowerCase())}</h4>
                        <span class="booking-status ${booking.status}">${translateText(booking.status).toUpperCase()}</span>
                    </div>
                    <div class="booking-details">
                        <p><strong>Issue:</strong> ${booking.issueDescription}</p>
                        <p><strong>${translateText('preferred date')}:</strong> ${booking.preferredDate}</p>
                        <p><strong>${translateText('preferred time')}:</strong> ${booking.preferredTime}</p>
                        <p><strong>${translateText('contact')}:</strong> ${booking.contactNumber}</p>
                        <p><strong>Booked on:</strong> ${new Date(booking.createdAt).toLocaleDateString()}</p>
                        ${booking.acceptedAt ? `<p><strong>Accepted on:</strong> ${new Date(booking.acceptedAt).toLocaleDateString()}</p>` : ''}
                        ${booking.completedAt ? `<p><strong>Completed on:</strong> ${new Date(booking.completedAt).toLocaleDateString()}</p>` : ''}
                        ${booking.cancelledAt ? `<p><strong>Cancelled on:</strong> ${new Date(booking.cancelledAt).toLocaleDateString()}</p>` : ''}
                        ${booking.rating ? `<p><strong>Your Rating:</strong> ‚≠ê ${booking.rating}/5</p>` : ''}
                        ${booking.review ? `<p><strong>Your Review:</strong> "${booking.review}"</p>` : ''}
                    </div>
                    <div class="booking-contact-actions">
                        ${booking.status === 'accepted' || booking.status === 'completed' ? `
                            <a href="tel:${getWorkerContact(booking.workerId)}" class="btn btn-call">
                                üìû ${translateText('call now')}
                            </a>
                        ` : ''}
                        ${booking.status === 'pending' ? `
                            <button class="btn btn-danger" onclick="showCancelBooking('${booking.id}')">
                                ‚ùå ${translateText('cancel')} Booking
                            </button>
                        ` : ''}
                        ${booking.status === 'completed' && !booking.rating ? `
                            <button class="btn btn-primary" onclick="rateWorker('${booking.id}')">Rate Worker</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getWorkerContact(workerId) {
            const workers = getWorkers();
            const worker = workers.find(w => w.id === workerId);
            return worker ? worker.contact : '';
        }

        function showCancelBooking(bookingId) {
            const bookings = getBookings();
            selectedBookingForCancel = bookings.find(b => b.id === bookingId);
            
            if (selectedBookingForCancel) {
                // Populate booking info in cancel modal
                document.getElementById('cancelBookingInfo').innerHTML = `
                    <div class="cancel-booking-details">
                        <h4>${selectedBookingForCancel.workerName}</h4>
                        <p><strong>Service:</strong> ${translateText(selectedBookingForCancel.workerProfession.toLowerCase())}</p>
                        <p><strong>Date:</strong> ${selectedBookingForCancel.preferredDate}</p>
                        <p><strong>Time:</strong> ${selectedBookingForCancel.preferredTime}</p>
                        <p><strong>Issue:</strong> ${selectedBookingForCancel.issueDescription}</p>
                    </div>
                `;
                
                document.getElementById('cancelBookingModal').style.display = 'block';
            }
        }

        function closeCancelModal() {
            document.getElementById('cancelBookingModal').style.display = 'none';
            selectedBookingForCancel = null;
        }

        function confirmCancelBooking() {
            if (selectedBookingForCancel) {
                // Update booking status to cancelled
                const bookings = getBookings();
                const bookingIndex = bookings.findIndex(b => b.id === selectedBookingForCancel.id);
                
                if (bookingIndex !== -1) {
                    bookings[bookingIndex].status = 'cancelled';
                    bookings[bookingIndex].cancelledAt = new Date().toISOString();
                    saveBookings(bookings);
                }
                
                // Close modal and refresh bookings
                closeCancelModal();
                loadMyBookings();
                
                alert('Booking cancelled successfully!');
            }
        }

        function rateWorker(bookingId) {
            const bookings = getBookings();
            selectedBookingForRating = bookings.find(b => b.id === bookingId);
            
            if (selectedBookingForRating) {
                // Populate worker info in rating modal
                document.getElementById('ratingWorkerInfo').innerHTML = `
                    <div class="rating-worker-details">
                        <h4>${selectedBookingForRating.workerName}</h4>
                        <p><strong>Service:</strong> ${translateText(selectedBookingForRating.workerProfession.toLowerCase())}</p>
                        <p><strong>Date:</strong> ${selectedBookingForRating.preferredDate}</p>
                    </div>
                `;
                
                // Reset rating form
                document.getElementById('selectedRating').value = '';
                document.getElementById('reviewComment').value = '';
                
                // Reset stars
                const stars = document.querySelectorAll('.star');
                stars.forEach(star => {
                    star.style.color = '#e2e8f0';
                    star.style.transform = 'scale(1)';
                });
                
                document.getElementById('ratingModal').style.display = 'block';
            }
        }

        function submitRating(e) {
            e.preventDefault();
            
            const rating = parseInt(document.getElementById('selectedRating').value);
            const comment = document.getElementById('reviewComment').value;
            
            if (!rating) {
                alert('Please select a rating');
                return;
            }
            
            // Update booking with rating
            const bookings = getBookings();
            const bookingIndex = bookings.findIndex(b => b.id === selectedBookingForRating.id);
            
            if (bookingIndex !== -1) {
                bookings[bookingIndex].rating = rating;
                bookings[bookingIndex].review = comment;
                bookings[bookingIndex].ratedAt = new Date().toISOString();
                saveBookings(bookings);
            }
            
            // Update worker's average rating
            updateWorkerRating(selectedBookingForRating.workerId, rating);
            
            // Close modal and refresh bookings
            document.getElementById('ratingModal').style.display = 'none';
            loadMyBookings();
            
            alert(`${translateText('thank you')} for your rating!`);
        }

        function updateWorkerRating(workerId, newRating) {
            const workers = getWorkers();
            const workerIndex = workers.findIndex(w => w.id === workerId);
            
            if (workerIndex !== -1) {
                const worker = workers[workerIndex];
                const bookings = getBookings().filter(b => 
                    b.workerId === workerId && 
                    b.rating && 
                    b.status === 'completed'
                );
                
                // Calculate new average rating
                const totalRatings = bookings.length;
                const sumRatings = bookings.reduce((sum, booking) => sum + booking.rating, 0);
                const averageRating = totalRatings > 0 ? (sumRatings / totalRatings).toFixed(1) : 0;
                
                workers[workerIndex].rating = parseFloat(averageRating);
                workers[workerIndex].completedJobs = totalRatings;
                
                saveWorkers(workers);
            }
        }

        function loadProfile() {
            const currentUser = getCurrentUser();
            const profileDisplay = document.getElementById('profileDisplay');
            
            profileDisplay.innerHTML = `
                <div class="profile-details">
                    <h4>${currentUser.name}</h4>
                    <p><strong>${translateText('email')}:</strong> ${currentUser.email}</p>
                    <p><strong>${translateText('phone')}:</strong> ${currentUser.phone || 'Not provided'}</p>
                    <p><strong>${translateText('address')}:</strong> ${currentUser.address || 'Not provided'}</p>
                    <p><strong>Member since:</strong> ${new Date(currentUser.createdAt).toLocaleDateString()}</p>
                </div>
                <div class="profile-actions">
                    <button class="btn btn-primary" onclick="editProfile()" data-translate="edit">Edit Profile</button>
                    <button class="btn btn-danger" onclick="showDeleteConfirmation()" data-translate="delete">Delete Account</button>
                </div>
            `;
        }

        function editProfile() {
            const currentUser = getCurrentUser();
            
            // Pre-fill form with current data
            document.getElementById('editName').value = currentUser.name;
            document.getElementById('editEmail').value = currentUser.email;
            document.getElementById('editPhone').value = currentUser.phone || '';
            document.getElementById('editAddress').value = currentUser.address || '';
            
            // Show edit form, hide display
            document.getElementById('profileDisplay').style.display = 'none';
            document.getElementById('profileEdit').style.display = 'block';
        }

        function cancelEdit() {
            document.getElementById('profileDisplay').style.display = 'block';
            document.getElementById('profileEdit').style.display = 'none';
        }

        function saveProfile(e) {
            e.preventDefault();
            
            const currentUser = getCurrentUser();
            const updatedUser = {
                ...currentUser,
                name: document.getElementById('editName').value,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value,
                address: document.getElementById('editAddress').value
            };
            
            // Update user in storage
            const users = getUsers();
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = updatedUser;
                saveUsers(users);
                setCurrentUser(updatedUser);
            }
            
            // Update welcome message
            document.getElementById('welcomeMessage').textContent = `${translateText('welcome')}, ${updatedUser.name}!`;
            
            // Show updated profile
            cancelEdit();
            loadProfile();
            
            alert('Profile updated successfully!');
        }

        function showDeleteConfirmation() {
            document.getElementById('deleteConfirmModal').style.display = 'block';
            document.getElementById('deleteConfirmText').value = '';
            document.getElementById('confirmDeleteBtn').disabled = true;
        }

        function closeDeleteModal() {
            document.getElementById('deleteConfirmModal').style.display = 'none';
            document.getElementById('deleteConfirmText').value = '';
            document.getElementById('confirmDeleteBtn').disabled = true;
        }

        function handleDeleteConfirmation(e) {
            const confirmText = e.target.value;
            const deleteBtn = document.getElementById('confirmDeleteBtn');
            
            if (confirmText === 'DELETE') {
                deleteBtn.disabled = false;
                deleteBtn.classList.add('btn-danger-active');
            } else {
                deleteBtn.disabled = true;
                deleteBtn.classList.remove('btn-danger-active');
            }
        }

        function deleteAccount() {
            const currentUser = getCurrentUser();
            
            // Delete user account
            deleteUserAccount(currentUser.id);
            
            // Show success message and redirect
            alert('Your account has been successfully deleted. You will now be redirected to the login page.');
            
            // Clear session and redirect
            clearCurrentUser();
            window.location.href = 'index.html';
        }

        // Set minimum date to today
        document.getElementById('preferredDate').min = new Date().toISOString().split('T')[0];
    </script>
</body>
</html>
